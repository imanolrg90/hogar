{% extends "base.html" %}

{% block title %}Planificador Semanal{% endblock %}

{% block content %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
    :root {
        --bg-color: #F3F4F6;
        --card-bg: #ffffff;
        --primary: #6366f1; /* Indigo */
        --secondary: #f59e0b; /* Amber */
        --text-main: #1f2937;
        --text-muted: #9ca3af;
        --border-radius: 12px;
    }

    /* --- LAYOUT GENERAL --- */
    body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Inter', sans-serif; }
    
    .main-layout { display: block; width: 100%; max-width: 1400px; margin: 0 auto; padding-top: 10px; }

    /* --- BARRA UNIFICADA (NUEVO HEADER) --- */
    .unified-toolbar {
        display: grid;
        grid-template-columns: 1fr auto 1fr; /* Izq - Centro - Der */
        align-items: center;
        background: white;
        padding: 10px 20px;
        border-radius: 16px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        position: sticky; /* Se queda fija al hacer scroll */
        top: 10px;
        z-index: 30;
    }

    /* Sección Izquierda */
    .toolbar-left { display: flex; align-items: center; gap: 15px; }
    .app-logo-text { font-size: 1.2rem; font-weight: 800; color: #111827; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
    
    .status-badge {
        font-size: 0.75rem; font-weight: 600; padding: 4px 10px; border-radius: 20px;
        background: #ecfdf5; color: #059669; display: inline-flex; align-items: center; gap: 5px;
    }

    /* Sección Centro (Navegador) */
    .toolbar-center { display: flex; justify-content: center; }
    .week-navigator-compact {
        display: flex; align-items: center; gap: 10px;
        background: #f3f4f6; padding: 4px; border-radius: 10px;
    }
    .nav-btn {
        width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
        background: white; border-radius: 8px; color: var(--text-main); text-decoration: none; 
        transition: 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .nav-btn:hover { transform: scale(1.05); color: var(--primary); }
    
    .week-display { 
        text-align: center; min-width: 130px; display: flex; flex-direction: column; line-height: 1.1; 
    }
    .week-label { font-size: 0.65rem; text-transform: uppercase; color: #9ca3af; font-weight: 700; letter-spacing: 0.5px; }
    .week-value { font-size: 0.9rem; font-weight: 700; color: #374151; }

    /* Sección Derecha (Botones) */
    .toolbar-right { display: flex; justify-content: flex-end; gap: 10px; }

    .btn-primary-save {
        background: #111827; color: white; border: none; padding: 10px 20px;
        border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;
        transition: transform 0.1s; font-size: 0.9rem;
    }
    .btn-primary-save:active { transform: scale(0.98); }

    .btn-secondary-outline {
        background: white; border: 1px solid #d1d5db; color: #374151;
        padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer;
        display: flex; align-items: center; gap: 8px; transition: 0.2s; font-size: 0.9rem;
    }
    .btn-secondary-outline:hover { background: #f3f4f6; border-color: #9ca3af; }


    /* --- TABLA / CARDS DEL MENU --- */
    .menu-container { padding-bottom: 50px; }

    .menu-header-row {
        display: grid; grid-template-columns: 60px repeat(4, 1fr) 80px 80px; gap: 15px;
        padding: 0 20px 10px 20px; font-size: 0.75rem; font-weight: 700; 
        text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.05em; text-align: center;
    }

    .menu-day-row {
        background: var(--card-bg);
        border-radius: var(--border-radius);
        margin-bottom: 12px;
        padding: 15px 20px;
        display: grid; grid-template-columns: 60px repeat(4, 1fr) 80px 80px; gap: 15px;
        align-items: flex-start;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        transition: box-shadow 0.2s;
    }
    .menu-day-row:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

    /* Columna del Día */
    .day-column { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; min-height: 60px; }
    .day-badge {
        background: #1f2937; color: white; width: 50px; height: 50px;
        border-radius: 12px; display: flex; flex-direction: column; 
        align-items: center; justify-content: center;
        font-weight: 800; font-size: 0.9rem; margin-bottom: 4px; line-height: 1.1;
    }

    /* Celda de Comida */
    .meal-cell {
        min-height: 80px; display: flex; flex-direction: column; gap: 8px; position: relative;
        padding: 5px; border-radius: 8px; transition: background 0.2s;
    }
    .meal-cell:hover { background: #f9fafb; }

    /* --- CHIPS (ITEMS DENTRO DE LA CELDA) --- 
       MODIFICADO: Permite texto multilinea y altura variable 
    */
    .items-container { display: flex; flex-direction: column; gap: 6px; width: 100%; }

    .menu-item-chip {
        display: flex; 
        justify-content: space-between; 
        align-items: flex-start; /* Alineación superior para multilinea */
        padding: 8px 10px; /* Un poco más de espacio */
        border-radius: 6px; 
        font-size: 0.8rem;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
        transition: 0.2s;
        border-left: 3px solid #ccc; 
        background: white;
        height: auto; /* Altura automática */
    }
    .menu-item-chip.recipe { border-left-color: var(--primary); }
    .menu-item-chip.ingredient { border-left-color: var(--secondary); }

    .chip-text { 
        white-space: normal;   /* Permite salto de línea */
        overflow: visible;     /* Muestra todo el contenido */
        text-overflow: clip;   /* Quita los puntos suspensivos (...) */
        max-width: 100%;       /* Usa todo el ancho disponible */
        line-height: 1.2;      /* Mejor lectura en varias líneas */
        font-weight: 500; 
        word-break: break-word; 
    }
    
    .chip-info { font-size: 0.7rem; color: #9ca3af; margin-left: 5px; white-space: nowrap; }

    .btn-remove-chip {
        background: none; border: none; color: #ef4444; cursor: pointer;
        font-size: 0.9rem; padding: 0 0 0 8px; opacity: 0.6;
    }
    .btn-remove-chip:hover { opacity: 1; }

    /* Botón Circular (+) */
    .btn-add-circle {
        width: 28px; height: 28px; border-radius: 50%;
        background: white; border: 1px dashed #d1d5db; color: #9ca3af;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; margin-top: 5px; align-self: center;
        transition: all 0.2s;
    }
    .btn-add-circle:hover { border-color: var(--primary); color: var(--primary); transform: scale(1.1); }

    /* Stats */
    .stat-box {
        display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;
        border-radius: 8px; font-size: 0.9rem; font-weight: 700;
    }
    .stat-box.kcal { color: #d97706; background: #fffbeb; }
    .stat-box.price { color: #059669; background: #ecfdf5; }

    /* --- MODALES --- */
    .modal-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.5); z-index: 1000;
        justify-content: center; align-items: center; backdrop-filter: blur(4px);
    }
    .modal-content {
        background: white; width: 90%; max-width: 500px; border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column;
        max-height: 85vh; animation: modalPop 0.3s ease-out;
    }
    @keyframes modalPop { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    .modal-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 1.2rem; font-weight: 700; color: #1f2937; }
    .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #9ca3af; }
    .close-btn:hover { color: #ef4444; }
    .modal-body { padding: 20px; overflow-y: auto; }

    /* Toggle Switch del Modal */
    .toggle-container { display: flex; background: #f3f4f6; padding: 4px; border-radius: 8px; margin-bottom: 20px; }
    .toggle-btn {
        flex: 1; padding: 8px; text-align: center; cursor: pointer; border-radius: 6px; 
        font-size: 0.9rem; font-weight: 600; color: #6b7280; transition: 0.2s;
    }
    .toggle-btn.active { background: white; color: var(--text-main); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

    /* --- ESTILOS PARA EL BUSCADOR (SELECT2) --- */
    .select2-container .select2-selection--single {
        height: 42px !important;
        border: 1px solid #e5e7eb !important;
        border-radius: 8px !important;
        display: flex !important;
        align-items: center !important;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 40px !important;
    }
    .select2-dropdown {
        border-color: #e5e7eb !important;
        border-radius: 8px !important;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
        z-index: 9999 !important; /* Asegurar que sale encima del modal */
    }

    .modern-select, .modern-input-small {
        width: 100%; padding: 10px; font-size: 0.9rem; border: 1px solid #e5e7eb; border-radius: 8px; 
        background: #fff; margin-bottom: 10px;
    }

    /* Estilos lista compra */
    .clean-list { list-style: none; padding: 0; margin: 0; }
    .shopping-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f3f4f6; }
    .item-badge { background: #1f2937; color: white; padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }

    /* Responsive */
    .mobile-only { display: none; }
    @media (max-width: 1024px) {
        .unified-toolbar { grid-template-columns: 1fr; gap: 10px; position: relative; top: 0; }
        .toolbar-left { justify-content: center; }
        .toolbar-center { order: 2; width: 100%; } 
        .week-navigator-compact { width: 100%; justify-content: space-between; }
        .toolbar-right { order: 3; justify-content: center; width: 100%; }
        
        .menu-header-row { display: none; }
        .menu-day-row { grid-template-columns: 1fr; gap: 0; padding: 10px; }
        .day-column { flex-direction: row; justify-content: flex-start; gap: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px; width: 100%; }
        .meal-cell { padding-bottom: 15px; border-bottom: 1px dashed #eee; margin-bottom: 10px; }
        .mobile-only { display: block; font-size: 0.7rem; font-weight: 700; color: var(--text-muted); margin-bottom: 5px; text-transform: uppercase; }
        .stat-box { flex-direction: row; justify-content: space-between; width: 100%; padding: 10px; background: #f9fafb; margin-top: 5px; }
        .mobile-hide { display: none; }
    }
</style>

<form method="POST" id="menuForm">
    <div class="main-layout">
        
        <div class="unified-toolbar">
            
            <div class="toolbar-left">
               
                {% if current_week == real_current_week %} 
                    <div class="status-badge mobile-hide">
                        <i class="fas fa-circle" style="font-size: 6px;"></i> Semana Actual
                    </div>
                {% endif %}
            </div>

            <div class="toolbar-center">
                <div class="week-navigator-compact">
                    <a href="{{ url_for('menu_semanal_page', week_str=prev_week) }}" class="nav-btn">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                    <div class="week-display">
                        <span class="week-label">Semana del</span>
                        <span class="week-value">{{ current_week.strftime('%d %b %Y') }}</span>
                    </div>
                    <a href="{{ url_for('menu_semanal_page', week_str=next_week) }}" class="nav-btn">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </div>
            </div>

            <div class="toolbar-right">
                <button type="button" class="btn-secondary-outline" onclick="openModal()" title="Ver Lista de Compra">
                    <i class="fas fa-shopping-basket"></i> 
                    <span class="desktop-only">Lista</span>
                </button>
                <button type="submit" class="btn-primary-save" title="Guardar cambios">
                    <i class="fas fa-save"></i> 
                    <span class="desktop-only">Guardar</span>
                </button>
            </div>
        </div>

        <div class="menu-container">
            
            <div class="menu-content">
                
                <div class="menu-header-row desktop-only">
                    <div></div> 
                    <div>DESAYUNO</div>
                    <div>COMIDA</div>
                    <div>MERIENDA</div>
                    <div>CENA</div>
                    <div style="color: #d97706;">KCAL</div>
                    <div style="color: #059669;">PRECIO</div>
                </div>

                {% for dia_menu in menu %}
                <div class="menu-day-row">
                    <div class="day-column">
                        <div class="day-badge">
                            <span>{{ dia_menu.dia[:3]|upper }}</span>
                            <span style="font-size: 0.65rem; opacity: 0.8; font-weight: 400;">{{ dia_menu.fecha_str }}</span>
                        </div>
                    </div>
                    
                    {% for tipo in ['Desayuno', 'Comida', 'Merienda', 'Cena'] %}
                    <div class="meal-cell" id="cell_{{ dia_menu.dia }}_{{ tipo }}">
                        <span class="mobile-only">{{ tipo }}</span>
                        
                        <div class="items-container">
                            {% for sel in dia_menu.get_selections(tipo) %}
                                {% if sel.receta %}
                                    <div class="menu-item-chip recipe">
                                        <span class="chip-text">{{ sel.receta.title }}</span>
                                        <input type="hidden" name="{{ dia_menu.dia }}_{{ tipo }}_receta" value="{{ sel.receta.id }}">
                                        <button type="button" class="btn-remove-chip" onclick="this.closest('.menu-item-chip').remove()">×</button>
                                    </div>

                                {% elif sel.ingredient %}
                                    <div class="menu-item-chip ingredient">
                                        <div style="display: flex; flex-direction: column; width: 100%;">
                                            <span class="chip-text">{{ sel.ingredient.name }}</span>
                                            <span class="chip-info">{{ sel.quantity|int }}g</span>
                                        </div>
                                        <input type="hidden" name="{{ dia_menu.dia }}_{{ tipo }}_ing_id" value="{{ sel.ingredient.id }}">
                                        <input type="hidden" name="{{ dia_menu.dia }}_{{ tipo }}_ing_qty" value="{{ sel.quantity }}">
                                        <button type="button" class="btn-remove-chip" onclick="this.closest('.menu-item-chip').remove()">×</button>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>

                        <div class="btn-add-circle" onclick="openAddItemModal('{{ dia_menu.dia }}', '{{ tipo }}')" title="Añadir comida">
                            <i class="fas fa-plus"></i>
                        </div>

                    </div>
                    {% endfor %}

                    <div class="stat-box kcal">
                        {{ dia_menu.daily_stats.kcal }}
                    </div>
                    <div class="stat-box price">
                        {{ "%.2f"|format(dia_menu.daily_stats.price) }}€
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</form>

<div id="shoppingModal" class="modal-overlay" onclick="closeModal(event)">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title"><i class="fas fa-shopping-basket"></i> Lista de Compra</div>
            <button type="button" class="close-btn" onclick="closeModalDirect()">&times;</button>
        </div>
        <div class="modal-body">
            {% if lista_compra %}
                <div style="background: #FFFBEB; color: #D97706; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.85rem;">
                    <i class="fas fa-info-circle"></i> Estos ingredientes se calculan según el menú guardado.
                </div>
                <ul class="clean-list">
                    {% for item in lista_compra %}
                    <li class="shopping-item">
                        <span class="item-name" style="font-weight: 500;">{{ item.nombre }}</span>
                        <span class="item-badge">{{ item.cantidad|round(1) if item.cantidad % 1 else item.cantidad|int }} {{ item.unidad }}</span>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="empty-shopping" style="text-align: center; padding: 40px 0; color: #9ca3af;">
                    <i class="fas fa-carrot" style="font-size: 3rem; margin-bottom: 10px; opacity: 0.3;"></i>
                    <p>Guarda el menú para generar la lista.</p>
                </div>
            {% endif %}
        </div>
        <div style="padding: 15px 20px; border-top: 1px solid #eee; text-align: right;">
            <button type="button" class="btn-secondary-outline" onclick="closeModalDirect()" style="display: inline-flex;">Cerrar</button>
        </div>
    </div>
</div>

<div id="addItemModal" class="modal-overlay" onclick="closeAddItemModal(event)">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">Añadir al Menú</div>
            <button type="button" class="close-btn" onclick="closeAddItemModalDirect()">&times;</button>
        </div>
        
        <div class="modal-body">
            <div class="toggle-container">
                <div class="toggle-btn active" id="tabRecipe" onclick="switchTab('recipe')">Receta</div>
                <div class="toggle-btn" id="tabIngredient" onclick="switchTab('ingredient')">Ingrediente</div>
            </div>

            <div id="blockRecipe">
                <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; display: block;">Selecciona Receta:</label>
                <select id="modalRecipeSelect" class="modern-select" style="width: 100%;">
                    <option value="">Buscar receta...</option>
                    {% for r in recetas %}
                        <option value="{{ r.id }}" data-name="{{ r.title }}">{{ r.title }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="blockIngredient" style="display: none;">
                <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; display: block;">Selecciona Ingrediente:</label>
                <select id="modalIngredientSelect" class="modern-select" style="width: 100%; margin-bottom: 10px;">
                    <option value="">Buscar ingrediente...</option>
                    {% for ing in all_ingredients %}
                        <option value="{{ ing.id }}" data-name="{{ ing.name }}">{{ ing.name }}</option>
                    {% endfor %}
                </select>
                
                <label style="font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; display: block;">Cantidad (gramos):</label>
                <input type="number" id="modalIngredientQty" class="modern-input-small" placeholder="Ej: 100" style="text-align: left;">
            </div>

            <button type="button" class="btn-primary-save" style="width: 100%; justify-content: center; margin-top: 20px;" onclick="confirmAddItem()">
                Añadir
            </button>
        </div>
    </div>
</div>

<script>
    // --- INICIALIZAR BUSCADOR EN DESPLEGABLES ---
    $(document).ready(function() {
        // Activamos Select2 en los selectores del modal
        $('#modalRecipeSelect').select2({
            dropdownParent: $('#addItemModal'), // Importante: para que funcione dentro del modal
            width: '100%',
            placeholder: "Buscar receta..."
        });

        $('#modalIngredientSelect').select2({
            dropdownParent: $('#addItemModal'), // Importante: para que funcione dentro del modal
            width: '100%',
            placeholder: "Buscar ingrediente..."
        });
    });

    // Variables globales para contexto
    let currentDay = null;
    let currentType = null;
    let currentMode = 'recipe'; 

    // --- MODAL DE LISTA DE COMPRA ---
    function openModal() {
        document.getElementById('shoppingModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
    function closeModalDirect() {
        document.getElementById('shoppingModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    function closeModal(event) {
        if (event.target === document.getElementById('shoppingModal')) closeModalDirect();
    }

    // --- MODAL DE AÑADIR ITEM ---
    function openAddItemModal(dia, tipo) {
        currentDay = dia;
        currentType = tipo;
        
        // Reset inputs y selects (Select2 necesita trigger change)
        $('#modalRecipeSelect').val(null).trigger('change');
        $('#modalIngredientSelect').val(null).trigger('change');
        document.getElementById('modalIngredientQty').value = "";
        
        document.getElementById('modalTitle').innerText = `Añadir a ${tipo} (${dia})`;
        document.getElementById('addItemModal').style.display = 'flex';
        switchTab('recipe'); 
        document.body.style.overflow = 'hidden';
    }

    function closeAddItemModalDirect() {
        document.getElementById('addItemModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    
    function closeAddItemModal(event) {
        if (event.target === document.getElementById('addItemModal')) closeAddItemModalDirect();
    }

    // --- PESTAÑAS (RECETA vs INGREDIENTE) ---
    function switchTab(mode) {
        currentMode = mode;
        const btnRec = document.getElementById('tabRecipe');
        const btnIng = document.getElementById('tabIngredient');
        const blkRec = document.getElementById('blockRecipe');
        const blkIng = document.getElementById('blockIngredient');

        if (mode === 'recipe') {
            btnRec.classList.add('active');
            btnIng.classList.remove('active');
            blkRec.style.display = 'block';
            blkIng.style.display = 'none';
        } else {
            btnIng.classList.add('active');
            btnRec.classList.remove('active');
            blkIng.style.display = 'block';
            blkRec.style.display = 'none';
        }
    }

    // --- LÓGICA CORE: INYECTAR HTML ---
    function confirmAddItem() {
        const targetCellId = `cell_${currentDay}_${currentType}`;
        const container = document.querySelector(`#${targetCellId} .items-container`);
        
        if (currentMode === 'recipe') {
            // Usamos jQuery para coger el valor de Select2
            const select = $('#modalRecipeSelect');
            const id = select.val();
            // Obtenemos el nombre del atributo data (Select2 mantiene el DOM original)
            const name = select.find(':selected').data('name');
            
            if (!id) return alert("Selecciona una receta");

            const chipHtml = `
                <div class="menu-item-chip recipe">
                    <span class="chip-text">${name}</span>
                    <input type="hidden" name="${currentDay}_${currentType}_receta" value="${id}">
                    <button type="button" class="btn-remove-chip" onclick="this.closest('.menu-item-chip').remove()">×</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', chipHtml);

        } else {
            const select = $('#modalIngredientSelect');
            const qtyInput = document.getElementById('modalIngredientQty');
            const id = select.val();
            const name = select.find(':selected').data('name');
            const qty = qtyInput.value || 0;

            if (!id) return alert("Selecciona un ingrediente");

            const chipHtml = `
                <div class="menu-item-chip ingredient">
                     <div style="display: flex; flex-direction: column; width: 100%;">
                        <span class="chip-text">${name}</span>
                        <span class="chip-info">${qty}g</span>
                    </div>
                    <input type="hidden" name="${currentDay}_${currentType}_ing_id" value="${id}">
                    <input type="hidden" name="${currentDay}_${currentType}_ing_qty" value="${qty}">
                    <button type="button" class="btn-remove-chip" onclick="this.closest('.menu-item-chip').remove()">×</button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', chipHtml);
        }

        closeAddItemModalDirect();
    }

    // Cerrar con ESC
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            closeModalDirect();
            closeAddItemModalDirect();
        }
    });
</script>
{% endblock %}