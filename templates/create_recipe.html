{% extends "base.html" %}

{% block title %}
    {% if receta_editar %}Editar Receta{% else %}Nueva Receta{% endif %}
{% endblock %}

{% block content %}
<div class="page-container-fluid">
    
    <div class="header-section">
        <div>
            <h1 class="page-title">
                {% if receta_editar %}Editar Plato{% else %}Diseñador de Platos{% endif %}
            </h1>
            <p class="page-subtitle">
                {% if receta_editar %}Modifica los ingredientes y pasos de tu creación.{% else %}Crea, calcula y organiza tu próxima obra maestra.{% endif %}
            </p>
        </div>
        <div style="display: flex; gap: 15px;">
            <a href="{{ url_for('dashboard') }}" class="btn-cancel">
                Cancelar
            </a>
            <button type="submit" form="recipeForm" class="btn-save-primary">
                {% if receta_editar %}Guardar Cambios{% else %}Guardar Receta{% endif %}
            </button>
        </div>
    </div>

    <form method="POST" id="recipeForm" class="main-layout">
        
        <aside class="sidebar-panel">
            <div class="glass-card">
                <div class="panel-header">
                    <i class="fas fa-info-circle"></i>
                    <h3>Datos Generales</h3>
                </div>
                
                <div class="form-group">
                    <label class="premium-label">NOMBRE DEL PLATO</label>
                    <input type="text" name="title" class="premium-input" 
                           value="{{ receta_editar.title if receta_editar else '' }}" 
                           placeholder="Ej. Risotto de Setas" required autocomplete="off">
                </div>

                <div class="form-group">
                    <label class="premium-label">DESCRIPCIÓN</label>
                    <textarea name="description" class="premium-input" rows="3" placeholder="Nota de sabor...">{{ receta_editar.description if receta_editar else '' }}</textarea>
                </div>

                <div class="form-group">
                    <label class="premium-label">PASOS</label>
                    <textarea name="steps" class="premium-input" rows="10" placeholder="1. Preparación...">{{ receta_editar.steps if receta_editar else '' }}</textarea>
                </div>
            </div>
        </aside>

        <section class="content-panel">
            
            <div class="totals-hero glass-card">
                <div class="total-unit">
                    <span class="lbl">Energía Total</span>
                    <span class="val"><span id="totalKcal">0</span> <small>kcal</small></span>
                </div>
                <div class="divider"></div>
                <div class="total-unit">
                    <span class="lbl">Coste Estimado</span>
                    <span class="val price"><span id="totalPrice">0.00</span> <small>€</small></span>
                </div>
            </div>

            <div class="glass-card" style="margin-top: 20px;">
                <div class="panel-header" style="justify-content: space-between; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-carrot"></i>
                        <h3>Composición</h3>
                    </div>
                    <a href="{{ url_for('ingredients_manager') }}" class="link-action">
                        <i class="fas fa-external-link-alt"></i> Inventario
                    </a>
                </div>

                <div class="add-bar">
                    <div class="select-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <select id="ingredientSelect" class="clean-select">
                            <option value="">Buscar ingrediente...</option>
                            {% for ing in ingredients %}
                            <option value="{{ ing.id }}" 
                                    data-name="{{ ing.name }}" 
                                    data-kcal="{{ ing.kcal_100g }}" 
                                    data-price="{{ ing.price_kg }}">
                                {{ ing.name }} — {{ "%.2f"|format(ing.price_kg) }} €/kg
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="qty-wrapper">
                        <input type="number" id="ingredientQty" class="clean-input" placeholder="0">
                        <span class="unit-label">g</span>
                    </div>

                    <button type="button" onclick="addIngredient()" class="btn-add">
                        <i class="fas fa-plus"></i> Añadir
                    </button>
                </div>

                <div class="table-container">
                    <table class="premium-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Ingrediente</th>
                                <th style="text-align: right;">Cantidad</th>
                                <th style="text-align: right;">Kcal</th>
                                <th style="text-align: right;">Coste</th>
                                <th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody id="ingredientsList"></tbody>
                    </table>
                    
                    <div id="emptyState" class="empty-state">
                        <i class="fas fa-basket-shopping"></i>
                        <p>Añade ingredientes para calcular costes.</p>
                    </div>
                </div>
            </div>
            
            <input type="hidden" name="ingredients_data" id="ingredientsData">
        </section>
    </form>
</div>

<style>
    /* --- LAYOUT FLUIDO --- */
    .page-container-fluid { 
        width: 96%; /* Ocupa casi toda la pantalla */
        max-width: 1800px; /* Límite para pantallas ultrawide */
        margin: 0 auto; 
        padding-bottom: 80px; 
    }
    
    .main-layout { 
        display: grid; 
        grid-template-columns: 380px 1fr; /* Izquierda fija, Derecha llena el resto */
        gap: 30px; 
        align-items: start; 
    }

    /* En móvil, una sola columna */
    @media(max-width: 900px) { 
        .main-layout { grid-template-columns: 1fr; } 
        .sidebar-panel { position: static !important; }
    }

    /* --- SIDEBAR STICKY --- */
    .sidebar-panel {
        position: sticky;
        top: 20px; /* Se queda pegado al hacer scroll */
        height: fit-content;
    }

    /* --- TARJETAS GLASS --- */
    .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 1);
        box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        border-radius: 20px;
        padding: 25px;
    }

    /* --- HEADER --- */
    .header-section { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px; }
    .page-title { font-size: 2rem; font-weight: 800; letter-spacing: -1px; color: var(--text-main); margin: 0; }
    .page-subtitle { color: var(--text-muted); font-size: 0.95rem; margin-top: 5px; }

    /* --- INPUTS --- */
    .premium-label { font-size: 0.7rem; font-weight: 700; color: #6B7280; margin-bottom: 8px; display: block; letter-spacing: 0.5px; text-transform: uppercase;}
    .premium-input {
        width: 100%; background: #F3F4F6; border: 1px solid transparent; border-radius: 12px; padding: 12px 16px;
        font-family: 'Inter', sans-serif; font-size: 0.95rem; box-sizing: border-box; transition: 0.2s;
    }
    .premium-input:focus { background: white; box-shadow: 0 0 0 3px rgba(0,0,0,0.05); outline: none; }
    .form-group { margin-bottom: 20px; }

    /* --- HERO TOTALES --- */
    .totals-hero {
        display: flex; align-items: center; justify-content: space-around;
        background: linear-gradient(135deg, #1F2937 0%, #111827 100%);
        color: white; padding: 30px;
    }
    .total-unit { text-align: center; }
    .total-unit .lbl { display: block; font-size: 0.8rem; text-transform: uppercase; opacity: 0.7; margin-bottom: 5px; font-weight: 600; }
    .total-unit .val { font-size: 2.5rem; font-weight: 800; line-height: 1; letter-spacing: -1px; }
    .total-unit .val.price { color: #34D399; }
    .total-unit .val small { font-size: 1rem; font-weight: 400; opacity: 0.8; }
    .totals-hero .divider { width: 1px; height: 50px; background: rgba(255,255,255,0.1); }

    /* --- BARRA AÑADIR --- */
    .add-bar {
        display: grid; grid-template-columns: 1fr 140px auto; gap: 15px; margin-bottom: 25px;
        background: #F8FAFC; padding: 10px; border-radius: 16px; border: 1px solid #E2E8F0;
    }
    .select-wrapper { display: flex; align-items: center; background: white; border-radius: 10px; padding-left: 12px; border: 1px solid transparent; flex: 1; }
    .select-wrapper:focus-within { border-color: #CBD5E1; }
    .clean-select { width: 100%; border: none; background: transparent; padding: 12px; outline: none; font-size: 0.95rem; }
    .qty-wrapper { display: flex; align-items: center; background: white; border-radius: 10px; padding: 0 12px; border: 1px solid transparent; }
    .qty-wrapper:focus-within { border-color: #CBD5E1; }
    .clean-input { width: 100%; border: none; background: transparent; padding: 12px 0; outline: none; text-align: right; font-size: 1rem; }
    .unit-label { color: #94A3B8; font-weight: 600; margin-left: 5px; }
    .btn-add {
        background: #111827; color: white; border: none; border-radius: 10px; padding: 0 25px;
        font-weight: 600; cursor: pointer; transition: 0.2s; white-space: nowrap;
    }
    .btn-add:hover { background: black; }

    /* --- TABLA --- */
    .premium-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
    .premium-table th { font-size: 0.75rem; text-transform: uppercase; color: #94A3B8; padding: 0 20px 10px 20px; font-weight: 600; }
    .ingredient-row td { background: white; padding: 15px 20px; border-top: 1px solid #F1F5F9; border-bottom: 1px solid #F1F5F9; font-size: 0.95rem; }
    .ingredient-row td:first-child { border-left: 1px solid #F1F5F9; border-radius: 12px 0 0 12px; font-weight: 600; color: #1F2937; }
    .ingredient-row td:last-child { border-right: 1px solid #F1F5F9; border-radius: 0 12px 12px 0; }
    .ingredient-row:hover td { background: #F8FAFC; }

    /* --- BOTONES ACCIÓN --- */
    .btn-save-primary {
        background: #111827; color: white; padding: 12px 24px; border-radius: 12px; font-weight: 600;
        border: none; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: 0.2s;
    }
    .btn-save-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.2); }
    .btn-cancel {
        padding: 12px 20px; border-radius: 12px; font-weight: 600; color: #4B5563; text-decoration: none;
        background: white; border: 1px solid #E5E7EB; transition: 0.2s;
    }
    .btn-cancel:hover { background: #F3F4F6; }

    .empty-state { text-align: center; padding: 60px; color: #CBD5E1; }
    .empty-state i { font-size: 2.5rem; margin-bottom: 15px; display: block; opacity: 0.5; }
</style>
<script>
    let addedIngredients = [];
    
    // Carga inicial si estamos editando
    {% if preloaded_json %}
        try {
            addedIngredients = {{ preloaded_json|safe }};
            document.addEventListener('DOMContentLoaded', renderTable);
        } catch (e) {
            console.error("Error cargando ingredientes previos:", e);
        }
    {% endif %}

    function addIngredient() {
        const select = document.getElementById('ingredientSelect');
        const qtyInput = document.getElementById('ingredientQty');
        
        // 1. Diagnóstico de errores de usuario
        if (!select.value) {
            alert("⚠️ Por favor, selecciona un ingrediente de la lista.");
            select.focus();
            return;
        }
        if (!qtyInput.value || parseFloat(qtyInput.value) <= 0) {
            alert("⚠️ Debes introducir una cantidad válida (mayor que 0).");
            qtyInput.focus();
            return;
        }

        try {
            const option = select.options[select.selectedIndex];
            const qty = parseFloat(qtyInput.value);
            
            // 2. Lectura de datos (con valores por defecto por seguridad)
            const kcal100 = parseFloat(option.dataset.kcal) || 0;
            const pricePerKg = parseFloat(option.dataset.price) || 0;
            const ingName = option.dataset.name || option.text;

            const realKcal = (qty / 100) * kcal100;
            const realPrice = (qty / 1000) * pricePerKg;

            // 3. Añadir al array
            addedIngredients.push({
                id: select.value,
                name: ingName,
                qty: qty,
                realKcal: realKcal,
                realPrice: realPrice
            });

            renderTable();
            
            // 4. Limpiar formulario
            qtyInput.value = '';
            select.value = '';
            select.focus();

        } catch (error) {
            console.error(error);
            alert("Hubo un error interno al añadir el ingrediente. Revisa la consola (F12).");
        }
    }

    function removeIng(index) {
        const row = document.getElementById(`row-${index}`);
        if(row) {
            row.style.opacity = '0';
            row.style.transform = 'translateX(20px)';
        }
        setTimeout(() => {
            addedIngredients.splice(index, 1);
            renderTable();
        }, 200);
    }

    function renderTable() {
        const tbody = document.getElementById('ingredientsList');
        const emptyState = document.getElementById('emptyState');
        const hiddenInput = document.getElementById('ingredientsData');
        
        tbody.innerHTML = '';
        
        let sumKcal = 0;
        let sumPrice = 0;

        // Controlar estado vacío
        if (addedIngredients.length === 0) {
            if(emptyState) emptyState.style.display = 'block';
        } else {
            if(emptyState) emptyState.style.display = 'none';
        }

        // Generar filas
        addedIngredients.forEach((item, index) => {
            sumKcal += item.realKcal;
            sumPrice += item.realPrice;

            tbody.innerHTML += `
                <tr class="ingredient-row" id="row-${index}">
                    <td>${item.name}</td>
                    <td style="text-align: right; color: #4B5563;">${item.qty}g</td>
                    <td style="text-align: right; color: #6B7280;">${item.realKcal.toFixed(0)}</td>
                    <td style="text-align: right; font-weight: 700; color: #111827;">${item.realPrice.toFixed(2)} €</td>
                    <td style="text-align: center;">
                        <button type="button" onclick="removeIng(${index})" title="Eliminar"
                                style="border:none; background:none; color: #EF4444; cursor:pointer; font-size: 1.1rem;">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                </tr>
            `;
        });

        // Actualizar totales y el input oculto para el Backend
        document.getElementById('totalKcal').innerText = sumKcal.toFixed(0);
        document.getElementById('totalPrice').innerText = sumPrice.toFixed(2);
        
        if(hiddenInput) {
            hiddenInput.value = JSON.stringify(addedIngredients);
        }
    }
</script>
{% endblock %}